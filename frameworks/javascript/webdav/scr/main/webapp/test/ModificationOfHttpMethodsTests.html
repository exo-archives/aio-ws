<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Tests of the Webdav library</title>
<script language="JavaScript" src="jsunit/app/jsUnitCore.js"></script>
<script language="JavaScript" src="../js/webdav.js"></script>
<script language="JavaScript" type="text/javascript" src="webdavTestSetUpPages.js"></script>
<script>
	/**
	 * Created by The eXo Platform SAS.
	 * @author: <a href="mailto:dmitry.ndp@exoplatform.com.ua">Dmytro Nochevnov</a>
	 * @version $Id: $ Dec 09, 2008
	 * @copyright Copyright (C) 2003-2008 eXo Platform SAS.
	 * @license http://www.gnu.org/licenses/ GNU General Public License
	 */

    function exposeTestFunctionNames() {
        return ['testSetUp', 'testMKCOL', 'testOPTIONS', 'testPUT_GET_HEAD', 'testCOPY', 'testMOVE', 'testExtensionMethod'];
    }
    
    function testSetUp() {
        assertNotNull('Expected webdav is an object', webdav);

		// UNLOCK test_folder
        options = {
            depth: '0',
            operation: 'properties_list',
            properties_list: ['locktoken']
        };
        result = webdav.PROPFIND('', test_folder + '/', options);
		if ( result.status == 207 ) {
			var locktoken_pattern = /<D:locktoken>.*\n*.*<D:href>\n*(.*)\n*<\/D:href>.*\n*.*<\/D:locktoken>/;			
			if ( XMLtoString(result.content).match(locktoken_pattern) ) {
				var locktoken = XMLtoString(result.content).match(locktoken_pattern)[1];
		        // UNLOCK method		
		        var options = {
		            locktoken: locktoken 
		        };
		        webdav.UNLOCK('', test_folder + '/', options);
			}	
		}

        // clean of the test folder (twice delete the folder)
        webdav.DELETE('', test_folder + '/');
        var result = webdav.DELETE('', test_folder + '/');        
        assertEquals('Clean of test folder - test of status', 404, result.status);
		assertFalse('Clean of test folder - test of isSuccess() ', webdav.isSuccess(result.status));		
		assertTrue('Clean of test folder - test if Header "Server" is existed', result.headers['Server'] != 'undefined');				
    }

    function testMKCOL(){
        // create a collection
        var result = webdav.MKCOL('', test_folder);
        assertEquals('test of creating of collection', 201, result.status);
		assertTrue('test of creating of collection - test of webdav.isSuccess() ', webdav.isSuccess(result.status));
        
        // delete the collection
        result = webdav.DELETE('', test_folder + '/');
        assertEquals('test of deleting of collection', 204, result.status);
    }

    function testOPTIONS(){
        // create a collection
        var result = webdav.MKCOL('', test_folder);
        assertEquals('test of creating of collection', 201, result.status);

        // test OPTIONS method		
        var result = webdav.OPTIONS('', test_folder + '/');
        assertEquals('test of OPTIONS method - test of status', 200, result.status);

        if ( result.headers.hasOwnProperty('allow') ) {
			assertTrue('test of OPTIONS method - test of header "allow"', result.headers['allow'].indexOf('OPTIONS')>=0);			
		} else {
			if ( result.headers.hasOwnProperty('Allow') ) {
				assertTrue('test of OPTIONS method - test of header "Allow"', result.headers['Allow'].indexOf('OPTIONS')>=0);				
			} else {
				fail('test of OPTIONS method - test of header "Allow"');
			}
		}	
        
        // delete the collection
        result = webdav.DELETE('', test_folder + '/');
        assertEquals('test of deleting of collection', 204, result.status);
    }
    
    function testPUT_GET_HEAD(){    
        // create a collection
        var result = webdav.MKCOL('', test_folder);
        assertEquals('test of creating of collection', 201, result.status);

        // create a file with UTF-8 encoded name and save UTF-8 encoded contents 
        result = webdav.PUT('', test_folder + '/приклад.txt', {content: 'приклад'});
        assertEquals('test of creating of resource with UTF-8 encoded name and save UTF-8 encoded contents', 201, result.status);
        
        // get UTF-8 encoded content
        result = webdav.GET('', test_folder + '/приклад.txt');
        assertEquals('test of geting of UTF-8 encoded content - test of status', 200, result.status);
        assertEquals('test of geting of UTF-8 encoded content - test of content', 'приклад', result.content);		
        assertTrue('test of geting of UTF-8 encoded content - test of Header "Content-Type"', result.headers['Content-Type'].indexOf('text/plain') >= 0);

        // take HEAD of UTF-8 encoded resource
        result = webdav.HEAD('', test_folder + '/приклад.txt');
        assertEquals('test of taking of head of UTF-8 encoded content - test of status', 200, result.status);	
        assertTrue('test of taking of head of UTF-8 encoded content - test of Header "Content-Type"', result.headers['Content-Type'].indexOf('text/plain') >= 0);

        // delete the resource
        result = webdav.DELETE('', test_folder + '/приклад.txt');
        assertEquals('test of removing of resource', 204, result.status);

        // delete the collection
        result = webdav.DELETE('', test_folder + '/');
        assertEquals('test of removing of collection', 204, result.status);
    }        

    function testCOPY(){
        // create a collection test_folder
        var result = webdav.MKCOL('', test_folder);
        assertEquals('test of creating of collection', 201, result.status);

        // create a collection test_folder/цільова/
        var result = webdav.MKCOL('', test_folder + '/цільова');
        assertEquals('test of creating of collection', 201, result.status);

        // create a file and save some contents
        result = webdav.PUT('', test_folder + '/приклад.txt', {content: 'приклад'});
        assertEquals('test of creating of resource', 201, result.status);
        
		// test COPY file
        options = { 
            depth: 'infinity',
			destination: test_folder + '/цільова/приклад_новий.txt'
        };
        result = webdav.COPY('', test_folder + '/приклад.txt', options);
        assertEquals('test of copy of file ' + test_folder + '/приклад.txt to ' + test_folder + '/цільова/приклад_новий.txt', 201, result.status);

		// test COPY folder without options.depth and options.overwrite 
        options = { 
			destination: test_folder + '/цільова_нова'
        };
        result = webdav.COPY('', test_folder + '/цільова/', options);
        assertEquals('test of copy of folder ' + test_folder + '/цільова/ to ' + test_folder + '/цільова_нова without options.depth and options.overwrite', 201, result.status);

		// test COPY folder with options.depth = 'Infinity' and overwrite = false 
        options = { 
            depth: 'infinity',
			destination: test_folder + '/цільова_нова/',
			overwrite: false
        };
        result = webdav.COPY('', test_folder + '/цільова/', options);
        assertEquals('test of copy of folder ' + test_folder + '/цільова/ to ' + test_folder + '/цільова_нова with options.depth=Infinity and options.overwrite = false', 412, result.status);

        // test of COPY of folder by getting file '/цільова_нова/приклад_новий.txt'
        result = webdav.GET('', test_folder + '/цільова_нова/приклад_новий.txt');
        assertEquals('test of geting of UTF-8 encoded content - test of content', 'приклад', result.content);	

        // delete the collection
        result = webdav.DELETE('', test_folder + '/');
        assertEquals('test of deleting of collection', 204, result.status);
    }

    function testMOVE(){
	
        // create a collection test_folder
        var result = webdav.MKCOL('', test_folder);
        assertEquals('test of creating of collection', 201, result.status);

        // create a collection test_folder/цільова/
        var result = webdav.MKCOL('', test_folder + '/цільова');
        assertEquals('test of creating of collection', 201, result.status);

        // create a file and save some contents
        result = webdav.PUT('', test_folder + '/приклад.txt', {content: 'приклад'});
        assertEquals('test of creating of resource', 201, result.status);
      
		// test MOVE file
        options = { 
			depth: 'infinity',
			destination: test_folder + '/цільова/приклад_новий.txt'
        };
        result = webdav.MOVE('', test_folder + '/приклад.txt', options);
		// according to the [rfc2518, 8.9.4] expected result.status = 201:Created ("Test  MOVE.1")
        assertEquals('test of move of file ' + test_folder + '/приклад.txt to ' + test_folder + '/цільова/приклад_новий.txt ("Test  MOVE.1")', 201, result.status);

		// test MOVE folder with options.depth = 1
        options = { 
            depth: 1,
			destination: test_folder + '/цільова_нова/'
        };
        result = webdav.MOVE('', test_folder + '/цільова/', options);
        assertEquals('test of move of folder ' + test_folder + '/цільова/ to ' + test_folder + '/цільова_нова with options.depth = 1', 400, result.status);

		// test MOVE folder without options.depth and options.overwrite 
        options = { 
			destination: test_folder + '/цільова_нова'
        };
        result = webdav.MOVE('', test_folder + '/цільова/', options);
		// according to the [rfc2518, 8.9.4] expected result.status = 201:Created ("Test  MOVE.2")
		assertEquals('test of move of folder ' + test_folder + '/цільова/ to ' + test_folder + '/цільова_нова without options.depth and options.overwrite ("Test  MOVE.2")', 201, result.status);

        // test of MOVE of folder by getting file '/цільова/приклад_новий.txt'
        result = webdav.GET('', test_folder + '/цільова/приклад_новий.txt');
        assertEquals('test of MOVE of folder by getting removed file /цільова/приклад_новий.txt', 404, result.status);	

        // test of MOVE of folder by getting file '/цільова_нова/приклад_новий.txt'
        result = webdav.GET('', test_folder + '/цільова_нова/приклад_новий.txt');
        assertEquals('test of MOVE of folder by getting new file /цільова_нова/приклад_новий.txt - test of content', 'приклад', result.content);	

        // delete the collection
        result = webdav.DELETE('', test_folder + '/');
        assertEquals('test of deleting of collection', 204, result.status);    
	}

    function testExtensionMethod(){    
        // an particular duplicate PUT_GET_HEAD test using an ExtensionMethod
		
		// create a collection by using an ExtensionMethod
        var options = {
			method: 'MKCOL'
		}

		var result = webdav.ExtensionMethod('', test_folder, options);
        assertEquals('test of creating of collection by using ExtensionMethod', 201, result.status);

        // create a file with UTF-8 encoded name and save UTF-8 encoded contents by using an ExtensionMethod 
        options = {
			method: 'PUT',
			headers: new Array,
			body: 'приклад'
		}
		options.headers['Content-type'] = 'text/plain, charset=UTF-8';
		
        result = webdav.ExtensionMethod('', test_folder + '/приклад.txt', options);
        assertEquals('test of creating of resource with UTF-8 encoded name and save UTF-8 encoded contents by using an ExtensionMethod', 201, result.status);
        
        // get UTF-8 encoded content by using an ExtensionMethod 
        options = {
			method: 'GET'
		}
        result = webdav.ExtensionMethod('', test_folder + '/приклад.txt', options);
        assertEquals('test of geting of UTF-8 encoded content by using an ExtensionMethod - test of status', 200, result.status);
        assertEquals('test of geting of UTF-8 encoded content by using an ExtensionMethod - test of content', 'приклад', result.content);		
        assertTrue('test of geting of UTF-8 encoded content by using an ExtensionMethod - test of Header "Content-Type"', result.headers['Content-Type'].indexOf('text/plain') >= 0);

        // delete the collection by using an ExtensionMethod
        options = {
			method: 'DELETE'
		}
        result = webdav.ExtensionMethod('', test_folder + '/', options);
        assertEquals('test of removing of collection by using an ExtensionMethod', 204, result.status);
    }        

</script>
</head>
<body>
	<h1>eXo Platform Client Library of WebDAV Test Suite</h1>
	<p>This page contains a JSUnit tests of eXo Platform Client Library of WebDAV.</p>
</body>
</html>