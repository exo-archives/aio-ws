<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Tests of the Webdav library</title>
<script language="JavaScript" src="jsunit/app/jsUnitCore.js"></script>
<script language="JavaScript" src="../js/webdav.js"></script>
<script language="JavaScript" type="text/javascript" src="webdavTestSetUpPages.js"></script>
<script>
	/**
	 * Created by The eXo Platform SAS.
	 * @author: <a href="mailto:dmitry.ndp@exoplatform.com.ua">Dmytro Nochevnov</a>
	 * @version $Id: $ Dec 09, 2008
	 * @copyright Copyright (C) 2003-2008 eXo Platform SAS.
	 * @license http://www.gnu.org/licenses/ GNU General Public License
	 */

    function exposeTestFunctionNames() {
        return ['testSetUp', 'testSEARCH'];
    }
    
    function testSetUp() {
        assertNotNull('Expected webdav is an object', webdav);
        // clean of the test folder (twice delete the folder)
        webdav.DELETE('', test_folder + '/');
        var result = webdav.DELETE('', test_folder + '/');        
        assertEquals('Clean of test folder - test of status', 404, result.status);
		assertFalse('Clean of test folder - test of isSuccess() ', webdav.isSuccess(result.status));		
		assertTrue('Clean of test folder - test if Header "Server" is existed', result.headers['Server'] != 'undefined');		
    }

    function testSEARCH(){
        // create a collection
        var result = webdav.MKCOL('', test_folder);
        assertEquals('test of creating of collection', 201, result.status);
		assertTrue('test of creating of collection - test of webdav.isSuccess() ', webdav.isSuccess(result.status));

        // create a file and save some contents
        result = webdav.PUT('', test_folder + '/приклад.txt', {content: 'приклад'});
        assertEquals('test of creating of resource', 201, result.status);
        
		// test of SEARCH in the test_folder with 'sql' search language
        var options = {
            search_language: 'sql',
            search_request: "SELECT * FROM nt:base WHERE contains(*, 'текст для пошуку')",
			additional_headers: new  Array()
        };	
		options.additional_headers['Range'] = 'rows=0-99';
		options.additional_headers['MS-SEARCH-MAXROWS'] = 2000;
		options.additional_headers['MS-SEARCH-TOTALHITS'] = 't';
		options.additional_headers['MS-SEARCH-USECONTENTINDEX'] = 't';
		options.additional_headers['MS-SEARCH-IGNORENOISEONLY'] = 't';						

        result = webdav.SEARCH('', test_folder + '/', options);
        assertEquals('test of SEARCH in the ' + test_folder + '/ with "sql" search language and with MS-Headers (Test SEARCH.1, JCR-658)', 207, result.status);

		// test of SEARCH in the test_folder with 'xpath' search language
        var options = {
            search_language: 'xpath',
            search_request: "element(*, nt:unstructured)[jcr:contains(., 'текст для пошуку')]"
        };				

        result = webdav.SEARCH('', test_folder + '/', options);
        assertEquals('test of SEARCH in the ' + test_folder + '/ with "xpath" search language (Test SEARCH.2, JCR-659)', 207, result.status);

        // delete the resource
        result = webdav.DELETE('', test_folder + '/приклад.txt');
        assertEquals('test of removing of resource', 204, result.status);
                
        // delete the collection
        result = webdav.DELETE('', test_folder + '/');
        assertEquals('test of deleting of collection', 204, result.status);
    }
</script>
</head>
<body>
	<h1>eXo Platform Client Library of WebDAV Test Suite</h1>
	<p>This page contains a JSUnit tests of eXo Platform Client Library of WebDAV.</p>
</body>
</html>