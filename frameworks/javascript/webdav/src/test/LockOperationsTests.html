<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Tests of the Webdav library</title>
<script language="JavaScript" src="jsunit/app/jsUnitCore.js"></script>
<script language="JavaScript" src="../js/webdav.js"></script>
<script language="JavaScript" type="text/javascript" src="webdavTestSetUpPages.js"></script>
<script>
	/**
	 * Created by The eXo Platform SAS.
	 * @author: <a href="mailto:dmitry.ndp@exoplatform.com.ua">Dmytro Nochevnov</a>
	 * @version $Id: $ Dec 09, 2008
	 * @copyright Copyright (C) 2003-2008 eXo Platform SAS.
	 * @license http://www.gnu.org/licenses/ GNU General Public License
	 */
	
    function exposeTestFunctionNames() {
        return ['testSetUp', 'testLOCKandUNLOCK', 'testTearDown'];
    }
    
    function testSetUp() {
        assertNotNull('Expected webdav is an object', webdav);
        // clean of the test folder (twice delete the folder)
        webdav.DELETE('', test_folder + '/');
        var result = webdav.DELETE('', test_folder + '/');        
        assertEquals('Clean of test folder - test of status', 404, result.status);
		assertFalse('Clean of test folder - test of isSuccess() ', webdav.isSuccess(result.status));		
		assertTrue('Clean of test folder - test if Header "Server" is existed', result.headers['Server'] != 'undefined');		
    }

	function testLOCKandUNLOCK() {
       	// create collection
		var result = webdav.MKCOL('', test_folder);
        assertEquals('test of creating of collection', 201, result.status);

        // test LOCK method
        var options = {
            scope: 'exclusive',
            owner: webdav.url + test_folder + '/',
            depth: '0',
            timeout: 'Infinity'				
        };
        result = webdav.LOCK('', test_folder + '/', options);
        assertEquals('test of LOCK request to the ' + test_folder + '/', 200, result.status);

		result.content = XMLtoString(result.content);
        assertNotUndefined('test of LOCK request to the "' + test_folder + '/ - verifying of present of properties "locktoken"', result.content.match(/<D:locktoken>.*\n*.*<D:href>\n*(.*)\n*<\/D:href>.*\n*.*<\/D:locktoken>/)[1]);
		var locktoken = result.content.match(/<D:locktoken>.*\n*.*<D:href>\n*(.*)\n*<\/D:href>.*\n*.*<\/D:locktoken>/)[1];
        assertTrue('test of LOCK request to the "' + test_folder + '/ - verifying of present the word "opaquelocktoken" in the  properties "locktoken" ("Test LOCK.1")', locktoken.search(/opaquelocktoken/) >= 0);

		// test of PROPFIND to the test_folder - verifying of present of properties "locktoken"
        options = {
            depth: '0',
            operation: 'properties_list',
            properties_list: ['locktoken']
        };
        result = webdav.PROPFIND('', test_folder + '/', options);
        assertEquals('test of PROPFIND to the resource "' + test_folder  + '/"', 207, result.status);
		var locktoken_pattern = new RegExp("<D:locktoken>.*\n*.*<D:href>\n*" + locktoken + "\n*<\/D:href>.*\n*.*<\/D:locktoken>"); 	
        assertTrue('test of PROPFIND to the "' + test_folder + '/" - verifying of present of properties "locktoken" ("Test LOCK.1")', XMLtoString(result.content).search(locktoken_pattern) >= 0);		

        // trying to delete the locked collection
        result = webdav.DELETE('', test_folder + '/');
        assertEquals('trying to delete the locked collection', 423, result.status);

        // test UNLOCK method		
        var options = {
            locktoken: ''				
        };
        result = webdav.UNLOCK('', test_folder + '/', options);
        assertEquals('test of UNLOCK request to the ' + test_folder, 423, result.status);

        var options = {
            locktoken: locktoken				
        };
        result = webdav.UNLOCK('', test_folder + '/', options);
        assertEquals('test of UNLOCK request to the ' + test_folder, 204, result.status);

        // delete the collection
        result = webdav.DELETE('', test_folder + '/');
        assertEquals('test of deleting of collection', 204, result.status);
	}

	function testTearDown() {
		// UNLOCK test_folder
        options = {
            depth: '0',
            operation: 'properties_list',
            properties_list: ['locktoken']
        };
        result = webdav.PROPFIND('', test_folder + '/', options);
		if ( result.status == 207 ) {
			var locktoken_pattern = /<D:locktoken>.*\n*.*<D:href>\n*(.*)\n*<\/D:href>.*\n*.*<\/D:locktoken>/;			
			if ( XMLtoString(result.content).match(locktoken_pattern) ) {
				var locktoken = XMLtoString(result.content).match(locktoken_pattern)[1];
		        // UNLOCK method		
		        var options = {
		            locktoken: locktoken 
		        };
		        result = webdav.UNLOCK('', test_folder + '/', options);
	        	assertEquals('test of UNLOCK request to the ' + test_folder, 204, result.status);
			}			
		}
		
        // delete the collection
        webdav.DELETE('', test_folder + '/');
	} 

</script>
</head>
<body>
	<h1>eXo Platform Client Library of WebDAV Test Suite</h1>
	<p>This page contains a JSUnit tests of eXo Platform Client Library of WebDAV.</p>
</body>
</html>